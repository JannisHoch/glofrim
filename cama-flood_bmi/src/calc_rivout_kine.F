MODULE CALC_RIVOUT_KINE_MOD
CONTAINS
SUBROUTINE CALC_RIVOUT_KINE
! ================================================
! to   Calculate discharge, kinematic wave
! ================================================
USE PARKIND1   ,ONLY: JPIM, JPRB
USE MOD_INPUT  ,ONLY: DT
USE MOD_INPUT  ,ONLY: PMANRIV, PDSTMTH, PMINSLP
USE MOD_MAP    ,ONLY: I1NEXT,   NSEQALL,  NSEQRIV
USE MOD_MAP    ,ONLY: D2RIVELV, D2ELEVTN, D2NXTDST, D2RIVWTH
USE MOD_PROG   ,ONLY: D2RIVSTO_OUT, D2RIVOUT_OUT
USE MOD_DIAG   ,ONLY: D2RIVDPH, D2RIVVEL, D2RIVINF, D2SFCELV

implicit none

!$ SAVE
      INTEGER(KIND=JPIM) ::  ISEQ, JSEQ
      REAL(KIND=JPRB)    ::  DSLOPE, DAREA, DVEL
!$OMP THREADPRIVATE   (JSEQ, DSLOPE, DAREA, DVEL)
!
! ================================================
!$OMP PARALLEL DO
DO ISEQ=1, NSEQALL
  D2SFCELV(ISEQ,1) = D2RIVELV(ISEQ,1) + D2RIVDPH(ISEQ,1)          !! DIFFUSIVE
  D2RIVINF(ISEQ,1) = 0.D0
END DO
!$OMP END PARALLEL DO

!$OMP PARALLEL DO
DO ISEQ=1, NSEQRIV
  JSEQ   = I1NEXT(ISEQ)
  DSLOPE = (D2ELEVTN(ISEQ,1)-D2ELEVTN(JSEQ,1)) * D2NXTDST(ISEQ,1)**(-1.)
  DSLOPE = max(DSLOPE,PMINSLP)
  DVEL   = PMANRIV**(-1.) * DSLOPE**0.5 * D2RIVDPH(ISEQ,1)**(2./3.)
  DAREA  = D2RIVWTH(ISEQ,1) * D2RIVDPH(ISEQ,1)

  D2RIVVEL(ISEQ,1) = DVEL
  D2RIVOUT_OUT(ISEQ,1) = DAREA * DVEL
  D2RIVOUT_OUT(ISEQ,1) = MIN(  D2RIVOUT_OUT(ISEQ,1), D2RIVSTO_OUT(ISEQ,1)/DT )

  !$OMP ATOMIC
  D2RIVINF(JSEQ,1) = D2RIVINF(JSEQ,1) + D2RIVOUT_OUT(ISEQ,1)
END DO
!$OMP END PARALLEL DO

!$OMP PARALLEL DO
DO ISEQ=NSEQRIV+1, NSEQALL
  DSLOPE = PMINSLP
  DVEL   = PMANRIV**(-1.) * DSLOPE**0.5 * D2RIVDPH(ISEQ,1)**(2./3.)
  DAREA  = D2RIVWTH(ISEQ,1) * D2RIVDPH(ISEQ,1)

  D2RIVVEL(ISEQ,1) = DVEL
  D2RIVOUT_OUT(ISEQ,1) = DAREA * DVEL
  D2RIVOUT_OUT(ISEQ,1) = MIN(  D2RIVOUT_OUT(ISEQ,1), D2RIVSTO_OUT(ISEQ,1)/DT )
END DO
!$OMP END PARALLEL DO


END SUBROUTINE CALC_RIVOUT_KINE
END MODULE CALC_RIVOUT_KINE_MOD
