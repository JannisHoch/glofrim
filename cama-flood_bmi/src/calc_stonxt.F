MODULE CALC_STONXT_MOD
CONTAINS
SUBROUTINE CALC_STONXT
! ================================================
! to   calculate the storage in the next time step in FTCS diff. eq.
! ================================================
USE PARKIND1   ,ONLY: JPIM, JPRB
USE MOD_INPUT  ,ONLY: DT
USE MOD_MAP    ,ONLY: NSEQALL
USE MOD_PROG   ,ONLY: D2RIVOUT_OUT,D2FLDOUT_OUT,D2RIVSTO_OUT,D2FLDSTO_OUT,D2RUNOFF
USE MOD_DIAG   ,ONLY: D2RIVINF,    D2FLDINF,    D2PTHOUT,    D2PTHINF,    D2FLDFRC,    D2OUTFLW,    D2STORGE
USE MOD_DIAG   ,ONLY: DGLBSTOPRE,  DGLBSTONXT,  DGLBSTONEW,  DGLBRIVINF,  DGLBRIVOUT
IMPLICIT NONE

!*** LOCAL
!$ SAVE
INTEGER(KIND=JPIM)    ::  ISEQ
REAL(KIND=JPRB)       ::  DRIVROF, DFLDROF
!$OMP THREADPRIVATE      (DRIVROF, DFLDROF)
!!==============================
DGLBSTOPRE=0.D0
DGLBSTONXT=0.D0
DGLBSTONEW=0.D0
DGLBRIVINF=0.D0
DGLBRIVOUT=0.D0

!$OMP PARALLEL DO REDUCTION(+:DGLBSTOPRE,DGLBRIVINF,DGLBRIVOUT,DGLBSTONXT,DGLBSTONEW)
DO ISEQ=1, NSEQALL

  DGLBSTOPRE = DGLBSTOPRE + D2RIVSTO_OUT(ISEQ,1)    + D2FLDSTO_OUT(ISEQ,1)
  DGLBRIVINF = DGLBRIVINF + D2RIVINF(ISEQ,1)*DT     + D2FLDINF(ISEQ,1)*DT     + D2PTHINF(ISEQ,1)*DT
  DGLBRIVOUT = DGLBRIVOUT + D2RIVOUT_OUT(ISEQ,1)*DT + D2FLDOUT_OUT(ISEQ,1)*DT + D2PTHOUT(ISEQ,1)*DT

  D2RIVSTO_OUT(ISEQ,1) = D2RIVSTO_OUT(ISEQ,1) + D2RIVINF(ISEQ,1)*DT - D2RIVOUT_OUT(ISEQ,1)*DT
  D2RIVSTO_OUT(ISEQ,1) = MAX( D2RIVSTO_OUT(ISEQ,1), 0.D0 )

  D2FLDSTO_OUT(ISEQ,1) = D2FLDSTO_OUT(ISEQ,1) + D2FLDINF(ISEQ,1)*DT - D2FLDOUT_OUT(ISEQ,1)*DT &
                                              + D2PTHINF(ISEQ,1)*DT - D2PTHOUT(ISEQ,1)*DT
  IF( D2FLDSTO_OUT(ISEQ,1) < 0.D0 )THEN
    D2RIVSTO_OUT(ISEQ,1)=MAX( D2RIVSTO_OUT(ISEQ,1)+D2FLDSTO_OUT(ISEQ,1), 0.D0 )
    D2FLDSTO_OUT(ISEQ,1)=0.D0
  ENDIF

  DGLBSTONXT = DGLBSTONXT + D2RIVSTO_OUT(ISEQ,1) + D2FLDSTO_OUT(ISEQ,1)
  D2OUTFLW(ISEQ,1)=D2RIVOUT_OUT(ISEQ,1)+D2FLDOUT_OUT(ISEQ,1)+D2PTHOUT(ISEQ,1)

  DRIVROF = D2RUNOFF(ISEQ,1) * (1.D0-D2FLDFRC(ISEQ,1)) * DT
  DFLDROF = D2RUNOFF(ISEQ,1) *       D2FLDFRC(ISEQ,1)  * DT
  D2RIVSTO_OUT(ISEQ,1) = D2RIVSTO_OUT(ISEQ,1) + DRIVROF
  D2FLDSTO_OUT(ISEQ,1) = D2FLDSTO_OUT(ISEQ,1) + DFLDROF

  DGLBSTONEW=DGLBSTONEW+D2RIVSTO_OUT(ISEQ,1)+D2FLDSTO_OUT(ISEQ,1)
  D2STORGE(ISEQ,1)=D2RIVSTO_OUT(ISEQ,1)+D2FLDSTO_OUT(ISEQ,1)

END DO
!$OMP END PARALLEL DO

END SUBROUTINE CALC_STONXT
END MODULE CALC_STONXT_MOD
